---
title: "CLL ICGC_019"
author: "Ramon Massoni-Badosa"
date: "11/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objective
The purpose of this notebook is to unravel the evolution of intratumoral heterogeneity in patient 019 across its CLL clinical course.

# Pre-processing

## Load packages

```{r}
library(Seurat)
library(kBET)
library(cluster)
library(tidyverse)
```

## Load data
We will load the demultiplexed, filtered and normalized Seurat object and subset it to our patient of interest (019):

```{r}
richter <- readRDS("results/R_objects/richter_seurat_filtered_normalized.rds")
richter <- subset(richter, subset = patient_id == "ICGC_019")
```

## Source script with function definitions

```{r}
source("bin/utils.R")
```

# Non-linear dimensionality reduction (tSNE/UMAP)
To reduce the redundancy and noise of this dataset, we will perform feature extraction by detecting the most variable genes in the matrix (HVG). Then, we will reduce the dimensionality even more with Principal Component Analysis (PCA). Finally, we will use the most significant principal components (PCs) to embed cells in UMAP and tSNE space to visualize the heterogeneity:

```{r}
richter <- richter %>% 
  FindVariableFeatures() %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunTSNE(dims = 1:20) %>%
  RunUMAP(reduction = "pca", dims = 1:20)
levels_status <- c(
  "diagnosis_sp", 
  "relapse1_post-chlorambucil", 
  "relapse2_post-R-chlorambucil", 
  "relapse3_post-duve", 
  "richter_while-ibrutinib"
)
richter$status <- factor(richter$status, levels = levels_status)
Idents(richter) <- "status"
palette <- c("#999999", "#92e8df", "#632c63", "#e4624e", "#c0e212")
umap_status <- DimPlot(richter, reduction = "umap", cols = palette)
tsne_status <- DimPlot(richter, reduction = "tsne", cols = palette)
umap_status
tsne_status
```

# Clustering

```{r}
richter <- FindNeighbors(richter)
resolutions <- c(
  0.005,
  seq(0.01, 0.1, by = 0.01),
  seq(0.1, 1, by = 0.1), seq(1, 10, by = 1)
)
df_sil_width <- data.frame(num_k = c(), sil_width = c(), resolution = c())
df_sum_squares <- data.frame(num_k = c(), sum_squares = c(), resolution = c())
num_k <- 1
for (res in resolutions) {
  print(str_c("Current resolution is ", res))
  richter <-  FindClusters(richter, resolution = res, verbose = FALSE)
  curr_num_k <- length(levels(richter$seurat_clusters))
  if (curr_num_k == num_k) {
    next
  } else {
    # Calculate Silhouette Width for new k
    sil_width <- calc_sil_width(
      object = richter, 
      clusters = richter$seurat_clusters, 
      npcs = 5, 
      ncell = 2500
    )
    print(str_c("Current silhouette width is ", sil_width))
    curr_df_sil <- data.frame(num_k = curr_num_k, sil_width = sil_width, resolution = res)
    df_sil_width <- rbind(df_sil_width, curr_df_sil)
    
    # Calculate total within-cluster sum of squares for new k
    sum_squares <- calc_total_withink_ss(richter)
    print(str_c("Current total within-cluster sum of squares is ", sum_squares))
    curr_df_ss <- data.frame(num_k = curr_num_k, sum_squares = sum_squares, resolution = res)
    df_sum_squares <- rbind(df_sum_squares, curr_df_ss)
    
    # Update number of clusters
    num_k <- curr_num_k 
    print(str_c("Current number of clusters is ", num_k))
  }
}
ggplot(df_sil_width, aes(num_k, sil_width, label = num_k)) +
  geom_text() +    
  labs(x = "Number of clusters (k)", y = "Average Silhouette Width") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))

df_sum_squares %>% 
  filter(num_k <= 43) %>% 
  ggplot(aes(num_k, sum_squares, label = num_k)) +
    geom_text() + 
    geom_line() +
    labs(x = "Number of clusters (k)", y = "Total Within Sum of Squares") +
    theme_classic() +
    theme(plot.title = element_text(hjust = 0.5))

optimal_k <- 8
opt_resolution <- avgs_sil_width_df[avgs_sil_width_df$num_k == optimal_k, "resolution"]
richter <- FindClusters(object = richter, resolution = opt_resolution)
DimPlot(richter, reduction = "umap")
```

# Markers

```{r}
markers <- FindAllMarkers(richter, test.use = "wilcox")
iterable <- 0:(length(levels(richter$seurat_clusters)) - 1)
purrr::map(iterable, ~ head(markers[markers$cluster == .x, ], 10))
genes <- c("CXCR4", "CD74", "FKBP5", "CCL5", "LTB", "CD27", "HLA-DPB1", "ARHGAP24", 
           "EEF1B2", "IL7R", "NKG7", "MT-CO3", "BIRC5", "MKI67", "HIST1H3B", "AURKB", 
           "S100A8", "LYZ")
DotPlot(richter, features = genes, cols = c("blue", "red"), dot.scale = 8) + 
  RotatedAxis() +
  theme(axis.title.x = element_blank())
saveRDS(markers, "results/R_objects/markers_dataframe.rds")

# Gene Ontolgy Enrichment analysis: Biological Process & Cellular Compartment
iterable <- levels(markers$cluster)
go_list <- vector(mode = "list", length = 2)
names(go_list) <- c("BP", "CC")
for (i in names(go_list)) {
  markers_go <- purrr::map(iterable, function(x) {
    genes <- markers[markers$cluster == x, "gene"]
    max_length <- ifelse(length(genes) > 50, 50, length(genes))
    genes <- genes[1:max_length]
    go <- run_clusterProfiler(
      target = genes, 
      universe = rownames(richter), 
      ontology = i
    )
    max_length2 <- ifelse(nrow(go) > 6, 6, nrow(go))
    go[1:max_length2, ]
  })
  names(markers_go) <- iterable
  markers_go <- bind_rows(markers_go, .id = "cluster")
  go_list[[i]] <- markers_go
}
DT::datatable(go_list$BP)
DT::datatable(go_list$CC)

# Distribution of QC metrics per cluster
qc_metrics <- c("nCount_RNA", "nFeature_RNA", "percent_mt" )
qc_titles <- c(
  "Library Size (total UMI)", 
  "Library complexity (# detected genes", 
  "Percentage Mitochondrial Expression (%)"
)
purrr::map2(qc_metrics, qc_titles, function(metric, y_title) {
  ggplot(richter@meta.data, aes_string("seurat_clusters", metric, fill = "seurat_clusters")) +
    geom_violin() +
    labs(x = "Cluster", y = y_title) +
    theme_classic() +
    theme(legend.position = "none")
})

```
# Cell cycle scoring
```{r}
richter <- CellCycleScoring(richter, s.features = cc.genes$s.genes, g2m.features = cc.genes$g2m.genes)
FeaturePlot(richter, reduction = "umap", features = c("S.Score", "G2M.Score"))
```


# Cold shock scoring 

```{r}
cold_shock_signature <- readRDS("../../JULIA/current/2-CLL/results/R_objects/cold_shock_signature_up.rds")
richter <- AddModuleScore(richter, features = list(cold_shock_signature), name = "cold_shock_score")
VlnPlot(richter, features = "cold_shock_score1", group.by = "seurat_clusters")
VlnPlot(richter, features = "cold_shock_score1", group.by = "status")


# Note: compare with predicted time post-extraction (Marta Kullis metadata)!

#########################################################
richter_sub <- subset(richter, idents = c("0", "1", "2"))
richter_sub <- richter_sub %>% 
  FindVariableFeatures() %>% 
  ScaleData() %>% 
  RunPCA() %>% 
  RunTSNE(dims = 1:20) %>%
  RunUMAP(reduction = "pca", dims = 1:20)
umap_clusters <- DimPlot(richter_sub, reduction = "umap", cols = palette[c(2, 4, 5)], pt.size = 1)
Idents(richter_sub) <- "status"
umap_timepoints <- DimPlot(richter_sub, reduction = "umap", pt.size = 1)
bar_plot_count <- richter_sub@meta.data %>% 
  select("seurat_clusters", "status") %>% 
  ggplot(aes(x = status, fill = seurat_clusters)) +
    geom_bar() +
    labs(x = "", y = "Number of cells", fill = "cluster") +
    scale_fill_manual(values = palette[c(2, 4, 5)]) + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Percentage of cells
df <- richter_sub@meta.data %>% 
  select("seurat_clusters", "status") %>% 
  group_by(status, seurat_clusters) %>% 
  summarize(n_cells = n()) %>% 
  ungroup() %>% 
  group_by(status) %>% 
  mutate(total = sum(n_cells)) %>% 
  ungroup() %>% 
  mutate(pct_cells = n_cells / total * 100) 
bar_plot_pct <- ggplot(df, aes(x = status, y = pct_cells, fill = seurat_clusters)) +
  geom_col() +
  labs(x = "", y = "Percentage of cells (%)", fill = "cluster") +
  scale_fill_manual(values = palette[c(2, 4, 5)]) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
bar_plot_pct
ggarrange(
  plotlist = list(umap_clusters, umap_timepoints, bar_plot_count, bar_plot_pct), 
  nrow = 2, 
  ncol = 2
)

```






